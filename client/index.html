<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <img src="" alt="Image" id="image">
</body>

<script>
    const BASE_URL = 'https://dashboard-966111139735.europe-west4.run.app';
    const MAC_ADDRESS = '00:00:00:00:00:00';
    const RSSI = '-1';
    const FW_VERSION = '2.1.3';
    const BATTERY_VOLTAGE = '4.1';

    function setImage(src) {
        const image = document.getElementById('image');
        image.src = src;
    }

    function getApiKey() {
        return fetch(`${BASE_URL}/api/setup/`, {
            headers: {
                'ID': MAC_ADDRESS
            }
        })
            .then(response => response.json());
    }

    this.getApiKey().then((data) => {
        if (data.api_key) {
            setImage(data.image_url);
            getNewImage(data.api_key, 900);
        }
    });

    function getNewImage(apiKey, refreshRate) {
        fetch(`${BASE_URL}/api/display/`, {
            headers: {
                'ID': MAC_ADDRESS,
                'Access-Token': apiKey,
                'Refresh-Rate': refreshRate,
                'Battery-Voltage': BATTERY_VOLTAGE,
                'FW-Version': FW_VERSION,
                'RSSI': RSSI
            }
        })
            .then(response => response.json())
            .then((data) => {
                setImage(data.image_url);
                setTimeout(() => {
                    getNewImage(apiKey, data.refresh_rate);
                }, refreshRate * 1000);
            });
    }
</script>

</html>